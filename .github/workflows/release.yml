name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

# ─────────────────────────────────────────────────────────────────────────────
# OVERVIEW
#
# Linux  : static musl binaries via muslcc / dockcross
#   • x86_64  (with x64 ASM for ChaCha20/Poly1305/AES-GCM)
#   • i686    (no ASM)
#   • armv7   (armeabi-v7a hard-float, no ASM)
#   • aarch64 (ARMv8, no ASM)
#
# Windows: MSVC (TunSafe.sln → full GUI) + MinGW static CLI (x64 + x86)
#
# Android: prebuilt APK committed to the repo is published as-is.
#          The APK already ships arm64-v8a / armeabi-v7a / x86 .so libs.
# ─────────────────────────────────────────────────────────────────────────────

jobs:

  # ───────────────────────────────────────────────
  # Linux x86_64 — native musl, with x64 ASM
  # ───────────────────────────────────────────────
  build-linux-x86_64:
    name: Linux x86_64 (musl+ASM)
    runs-on: ubuntu-latest
    container:
      image: muslcc/x86_64:x86_64-linux-musl

    steps:
      - uses: actions/checkout@v4

      - name: Install clang
        run: apk add --no-cache clang

      - name: Build ASM objects
        run: |
          clang++ -c -march=skylake-avx512 \
            crypto/poly1305/poly1305-x64-linux.s \
            crypto/chacha20/chacha20-x64-linux.s

      - name: Build TunSafe
        run: |
          clang++ -I . -O3 -DNDEBUG \
            -DWITH_NETWORK_BSD=1 \
            -mssse3 \
            -static -pthread \
            -o tunsafe-linux-x86_64 \
            tunsafe_amalgam.cpp \
            crypto/aesgcm/aesni_gcm-x64-linux.s \
            crypto/aesgcm/aesni-x64-linux.s \
            crypto/aesgcm/ghash-x64-linux.s \
            chacha20-x64-linux.o \
            poly1305-x64-linux.o \
            -lrt
          strip tunsafe-linux-x86_64

      - uses: actions/upload-artifact@v4
        with:
          name: tunsafe-linux-x86_64
          path: tunsafe-linux-x86_64

  # ───────────────────────────────────────────────
  # Linux i686 — 32-bit x86, musl static
  # ───────────────────────────────────────────────
  build-linux-i686:
    name: Linux i686 (musl)
    runs-on: ubuntu-latest
    container:
      image: muslcc/x86_64:i686-linux-musl

    steps:
      - uses: actions/checkout@v4

      - name: Install clang
        run: apk add --no-cache clang

      - name: Build TunSafe
        run: |
          clang++ -I . -O3 -DNDEBUG \
            -DWITH_NETWORK_BSD=1 \
            -DCHACHA20_WITH_ASM=0 \
            -DBLAKE2S_WITH_ASM=0 \
            -mssse3 -m32 \
            -static -pthread \
            -o tunsafe-linux-i686 \
            tunsafe_amalgam.cpp \
            -lrt
          strip tunsafe-linux-i686

      - uses: actions/upload-artifact@v4
        with:
          name: tunsafe-linux-i686
          path: tunsafe-linux-i686

  # ───────────────────────────────────────────────
  # Linux ARMv7 — hard-float, via dockcross
  # ───────────────────────────────────────────────
  build-linux-armv7:
    name: Linux ARMv7 (dockcross)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Pull dockcross and generate script
        run: |
          docker run --rm dockcross/linux-armv7 > ./dockcross-armv7
          chmod +x ./dockcross-armv7

      - name: Build TunSafe
        run: |
          ./dockcross-armv7 bash -c "
            set -e
            arm-linux-gnueabihf-g++ -I . -O3 -DNDEBUG \
              -DWITH_NETWORK_BSD=1 \
              -DCHACHA20_WITH_ASM=0 \
              -DBLAKE2S_WITH_ASM=0 \
              -mfpu=neon -march=armv7-a+fp \
              -static -pthread \
              -o tunsafe-linux-armv7 \
              tunsafe_amalgam.cpp \
              -lrt
            arm-linux-gnueabihf-strip tunsafe-linux-armv7
          "

      - uses: actions/upload-artifact@v4
        with:
          name: tunsafe-linux-armv7
          path: tunsafe-linux-armv7

  # ───────────────────────────────────────────────
  # Linux AArch64 / ARMv8 — via dockcross
  # ───────────────────────────────────────────────
  build-linux-aarch64:
    name: Linux AArch64/ARMv8 (dockcross)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Pull dockcross and generate script
        run: |
          docker run --rm dockcross/linux-arm64 > ./dockcross-aarch64
          chmod +x ./dockcross-aarch64

      - name: Build TunSafe
        run: |
          ./dockcross-aarch64 bash -c "
            set -e
            aarch64-unknown-linux-gnu-g++ -I . -O3 -DNDEBUG \
              -DWITH_NETWORK_BSD=1 \
              -DCHACHA20_WITH_ASM=0 \
              -DBLAKE2S_WITH_ASM=0 \
              -static -pthread \
              -o tunsafe-linux-aarch64 \
              tunsafe_amalgam.cpp \
              -lrt
            aarch64-unknown-linux-gnu-strip tunsafe-linux-aarch64
          "

      - uses: actions/upload-artifact@v4
        with:
          name: tunsafe-linux-aarch64
          path: tunsafe-linux-aarch64

  # ───────────────────────────────────────────────
  # Windows MSVC — full GUI build (TunSafe.sln)
  # ───────────────────────────────────────────────
  build-windows-msvc:
    name: Windows MSVC x64 (GUI)
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Add MSBuild to PATH
        uses: microsoft/setup-msbuild@v2

      - name: Build Release x64
        run: msbuild TunSafe.sln /p:Configuration=Release /p:Platform=x64 /m /nologo

      - name: Collect artifacts
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path dist | Out-Null
          Get-ChildItem -Recurse -Filter "TunSafe.exe" |
            Where-Object { $_.FullName -match 'Release' } |
            ForEach-Object { Copy-Item $_.FullName dist\ -Force }
          Get-ChildItem -Recurse -Filter "ts.exe" |
            Where-Object { $_.FullName -match 'Release' } |
            ForEach-Object { Copy-Item $_.FullName dist\ -Force } -ErrorAction SilentlyContinue
          dir dist

      - uses: actions/upload-artifact@v4
        with:
          name: tunsafe-windows-msvc-x64
          path: dist\

  # ───────────────────────────────────────────────
  # Windows MinGW — static CLI (x86_64 + i686)
  # ───────────────────────────────────────────────
  build-windows-mingw:
    name: Windows MinGW static (${{ matrix.arch }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            triple: x86_64-w64-mingw32
          - arch: i686
            triple: i686-w64-mingw32

    steps:
      - uses: actions/checkout@v4

      - name: Install MinGW
        run: |
          sudo apt-get update -q
          sudo apt-get install -y mingw-w64

      - name: Build TunSafe CLI
        run: |
          ${{ matrix.triple }}-g++ -I . -O3 -DNDEBUG \
            -DWITH_NETWORK_WIN32=1 \
            -DCHACHA20_WITH_ASM=0 \
            -DBLAKE2S_WITH_ASM=0 \
            -static \
            -o tunsafe-windows-${{ matrix.arch }}.exe \
            tunsafe_amalgam.cpp \
            -lws2_32 -liphlpapi -lwinmm \
          || { echo "::warning::MinGW build failed — WIN32 backend may need porting"; exit 0; }
          ${{ matrix.triple }}-strip tunsafe-windows-${{ matrix.arch }}.exe 2>/dev/null || true

      - uses: actions/upload-artifact@v4
        with:
          name: tunsafe-windows-mingw-${{ matrix.arch }}
          path: tunsafe-windows-${{ matrix.arch }}.exe

  # ───────────────────────────────────────────────
  # Android — преднастроенный APK из репозитория
  #
  # APK содержит нативные .so для:
  #   lib/arm64-v8a/libnative-lib.so
  #   lib/armeabi-v7a/libnative-lib.so
  #   lib/x86/libnative-lib.so
  #
  # Инструкция по обновлению APK:
  #   1. Положить новый APK в папку android/ в репозитории
  #   2. Переименовать в TunSafe-Android.apk
  #   3. Закоммитить
  # ───────────────────────────────────────────────
  prepare-android:
    name: Android APK (prebuilt)
    runs-on: ubuntu-latest
    env:
      APK_PATH: android/TunSafe-Android.apk

    steps:
      - uses: actions/checkout@v4

      - name: Copy current APK into repo structure
        run: |
          mkdir -p android
          # If APK is not yet in the repo, try to use one from git history
          # or fail clearly.
          if [ ! -f "$APK_PATH" ]; then
            echo "::error::APK not found at $APK_PATH"
            echo ""
            echo "To fix: place TunSafe-Android.apk into the android/ directory and commit."
            exit 1
          fi

      - name: Rename APK with release version
        run: |
          VERSION="${GITHUB_REF_NAME:-prerelease}"
          cp "$APK_PATH" "TunSafe-Android-${VERSION}.apk"
          echo "APK size: $(du -sh TunSafe-Android-${VERSION}.apk | cut -f1)"

      - uses: actions/upload-artifact@v4
        with:
          name: tunsafe-android-apk
          path: TunSafe-Android-*.apk

  # ───────────────────────────────────────────────
  # Release — собираем всё и публикуем
  # Только при push тега v*
  # ───────────────────────────────────────────────
  release:
    name: Publish GitHub Release
    needs:
      - build-linux-x86_64
      - build-linux-i686
      - build-linux-armv7
      - build-linux-aarch64
      - build-windows-msvc
      - build-windows-mingw
      - prepare-android
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: List collected files
        run: find artifacts/ -type f | sort

      - name: Compress Linux binaries (gzip)
        run: |
          for f in \
            artifacts/tunsafe-linux-x86_64/tunsafe-linux-x86_64 \
            artifacts/tunsafe-linux-i686/tunsafe-linux-i686 \
            artifacts/tunsafe-linux-armv7/tunsafe-linux-armv7 \
            artifacts/tunsafe-linux-aarch64/tunsafe-linux-aarch64; do
            [ -f "$f" ] && gzip -9 -k "$f" || true
          done

      - name: Generate SHA256SUMS
        run: |
          find artifacts/ -type f | sort | xargs sha256sum | tee SHA256SUMS.txt

      - name: Publish Release
        uses: softprops/action-gh-release@v2
        with:
          name: TunSafe ${{ github.ref_name }}
          draft: false
          prerelease: ${{ contains(github.ref_name, '-rc') || contains(github.ref_name, '-beta') || contains(github.ref_name, '-alpha') }}
          generate_release_notes: true
          body: |
            ## TunSafe ${{ github.ref_name }}

            ### Downloads

            | Platform | Architecture | Notes |
            |----------|-------------|-------|
            | Linux | x86_64 | musl static + ASM (ChaCha20/Poly1305/AES-GCM) |
            | Linux | i686 | musl static |
            | Linux | ARMv7 (armeabi-v7a) | musl static, NEON |
            | Linux | AArch64 / ARMv8 | musl static |
            | Windows | x86_64 GUI | MSVC release build |
            | Windows | x86_64 CLI | MinGW static |
            | Windows | i686 CLI | MinGW static |
            | Android | arm64-v8a + armeabi-v7a + x86 | Prebuilt APK |

            Verify integrity with `SHA256SUMS.txt` included in the release.
          files: |
            artifacts/**/*
            SHA256SUMS.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
