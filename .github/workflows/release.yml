name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

# ─────────────────────────────────────────────────────────────────────────────
# CHANGES vs previous run:
#
# FIX - Android linker "undefined symbol: CreateTunsafePlugin":
#   Caused by -include wireguard.h in CMakeLists — clang processed wireguard.h
#   as a force-include in tunsafe_wg_plugin.cpp's TU, which triggered
#   a #pragma once guard on the second #include "wireguard.h" inside that file.
#   This caused the linker to not see the symbol in some NDK versions.
#
#   CORRECT FIX:
#   1. Remove -include from CMakeLists entirely.
#   2. Add idempotent forward decl patch to tunsafe_wg_plugin.h in patch-sources.
#      Uses "grep -q" to check before patching — safe to run multiple times.
#      A bare forward decl "class WireguardProcessor;" is valid C++ regardless
#      of how many times it appears, and does NOT break the amalgam build.
# ─────────────────────────────────────────────────────────────────────────────

jobs:

  # ─────────────────────────────────────────────────────────────────
  # Патч исходников — применяется один раз, все job'ы скачивают результат
  # ─────────────────────────────────────────────────────────────────
  patch-sources:
    name: Patch sources
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # FIX 1: offsetof(Node, child[bits]) — VLA в offsetof не работает в GCC 10+
      - name: Patch ip_to_peer_map.cpp (offsetof VLA)
        run: |
          sed -i \
            's/malloc(offsetof(RoutingTrie32::Node, child\[(uint32)(1U << bits)\]))/malloc(offsetof(RoutingTrie32::Node, child) + ((size_t)(1U << bits)) * sizeof(RoutingTrie32::Node*))/' \
            ip_to_peer_map.cpp
          grep -n "malloc(offsetof" ip_to_peer_map.cpp

      # FIX 2: tunsafe_wg_plugin.h:39 использует WireguardProcessor* без forward decl.
      # Патч IDEMPOTENT: grep -q проверяет наличие перед применением.
      # Безопасно для amalgam — forward decl допустим много раз в C++.
      - name: Patch tunsafe_wg_plugin.h (WireguardProcessor forward decl)
        run: |
          if grep -q "class WireguardProcessor;" tunsafe_wg_plugin.h; then
            echo "tunsafe_wg_plugin.h already patched, skipping"
          else
            sed -i \
              's|#include "wireguard_proto.h"|#include "wireguard_proto.h"\nclass WireguardProcessor;|' \
              tunsafe_wg_plugin.h
            echo "Patched tunsafe_wg_plugin.h:"
            head -5 tunsafe_wg_plugin.h
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: patched-sources
          path: |
            ip_to_peer_map.cpp
            tunsafe_wg_plugin.h

  # ─────────────────────────────────────────────────────────────────
  # Linux x86_64 — static + ASM
  # ─────────────────────────────────────────────────────────────────
  build-linux-x86_64:
    name: Linux x86_64 (static + ASM)
    runs-on: ubuntu-latest
    needs: patch-sources
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: patched-sources
      - name: Install dependencies
        run: sudo apt-get update -q && sudo apt-get install -y gcc g++ binutils
      - name: Build ASM objects
        run: |
          gcc -c -march=skylake-avx512 \
            crypto/poly1305/poly1305-x64-linux.s \
            crypto/chacha20/chacha20-x64-linux.s
      - name: Build TunSafe
        run: |
          g++ -I . -O3 -DNDEBUG \
            -DWITH_NETWORK_BSD=1 \
            -mssse3 -std=gnu++14 \
            -static -pthread \
            -o tunsafe-linux-x86_64 \
            tunsafe_amalgam.cpp \
            crypto/aesgcm/aesni_gcm-x64-linux.s \
            crypto/aesgcm/aesni-x64-linux.s \
            crypto/aesgcm/ghash-x64-linux.s \
            chacha20-x64-linux.o \
            poly1305-x64-linux.o \
            -lrt
          strip tunsafe-linux-x86_64
          file tunsafe-linux-x86_64
      - uses: actions/upload-artifact@v4
        with:
          name: tunsafe-linux-x86_64
          path: tunsafe-linux-x86_64

  # ─────────────────────────────────────────────────────────────────
  # Linux i686 — static
  # ─────────────────────────────────────────────────────────────────
  build-linux-i686:
    name: Linux i686 (static)
    runs-on: ubuntu-latest
    needs: patch-sources
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: patched-sources
      - name: Install dependencies
        run: sudo apt-get update -q && sudo apt-get install -y gcc-multilib g++-multilib
      - name: Build TunSafe
        run: |
          g++ -m32 -I . -O3 -DNDEBUG \
            -DWITH_NETWORK_BSD=1 \
            -DCHACHA20_WITH_ASM=0 -DBLAKE2S_WITH_ASM=0 \
            -mssse3 -std=gnu++14 \
            -static -pthread \
            -o tunsafe-linux-i686 \
            tunsafe_amalgam.cpp \
            -lrt
          strip tunsafe-linux-i686
          file tunsafe-linux-i686
      - uses: actions/upload-artifact@v4
        with:
          name: tunsafe-linux-i686
          path: tunsafe-linux-i686

  # ─────────────────────────────────────────────────────────────────
  # Linux ARMv7 — dockcross ($CXX устанавливается автоматически)
  # ─────────────────────────────────────────────────────────────────
  build-linux-armv7:
    name: Linux ARMv7 (dockcross static)
    runs-on: ubuntu-latest
    needs: patch-sources
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: patched-sources
      - name: Setup dockcross armv7
        run: |
          docker run --rm dockcross/linux-armv7 > ./dockcross-armv7
          chmod +x ./dockcross-armv7
      - name: Build TunSafe
        run: |
          ./dockcross-armv7 bash -c "
            set -e
            echo 'CXX=' \$CXX
            \$CXX \
              -I . -O2 -DNDEBUG \
              -DWITH_NETWORK_BSD=1 \
              -DCHACHA20_WITH_ASM=0 -DBLAKE2S_WITH_ASM=0 \
              -mfpu=neon -march=armv7-a+fp \
              -std=gnu++14 -static -pthread \
              -o tunsafe-linux-armv7 \
              tunsafe_amalgam.cpp -lrt
            \$STRIP tunsafe-linux-armv7
            file tunsafe-linux-armv7
          "
      - uses: actions/upload-artifact@v4
        with:
          name: tunsafe-linux-armv7
          path: tunsafe-linux-armv7

  # ─────────────────────────────────────────────────────────────────
  # Linux AArch64 — dockcross
  # ─────────────────────────────────────────────────────────────────
  build-linux-aarch64:
    name: Linux AArch64/ARMv8 (dockcross static)
    runs-on: ubuntu-latest
    needs: patch-sources
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: patched-sources
      - name: Setup dockcross aarch64
        run: |
          docker run --rm dockcross/linux-arm64 > ./dockcross-aarch64
          chmod +x ./dockcross-aarch64
      - name: Build TunSafe
        run: |
          ./dockcross-aarch64 bash -c "
            set -e
            echo 'CXX=' \$CXX
            \$CXX \
              -I . -O2 -DNDEBUG \
              -DWITH_NETWORK_BSD=1 \
              -DCHACHA20_WITH_ASM=0 -DBLAKE2S_WITH_ASM=0 \
              -std=gnu++14 -static -pthread \
              -o tunsafe-linux-aarch64 \
              tunsafe_amalgam.cpp -lrt
            \$STRIP tunsafe-linux-aarch64
            file tunsafe-linux-aarch64
          "
      - uses: actions/upload-artifact@v4
        with:
          name: tunsafe-linux-aarch64
          path: tunsafe-linux-aarch64

  # ─────────────────────────────────────────────────────────────────
  # Windows MSVC — GUI (PlatformToolset=v143, WindowsTargetPlatformVersion=10.0)
  # ─────────────────────────────────────────────────────────────────
  build-windows-msvc:
    name: Windows MSVC x64 (GUI)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: microsoft/setup-msbuild@v2
      - name: Build
        run: |
          msbuild TunSafe.sln `
            /p:Configuration=Release `
            /p:Platform=x64 `
            /p:WindowsTargetPlatformVersion=10.0 `
            /p:PlatformToolset=v143 `
            /m /nologo
      - name: Collect artifacts
        shell: pwsh
        run: |
          New-Item -Force -ItemType Directory dist | Out-Null
          Get-ChildItem -Recurse -Filter "*.exe" |
            Where-Object { $_.FullName -match 'x64.Release' } |
            ForEach-Object { Copy-Item $_.FullName dist\ -Force }
          dir dist
      - uses: actions/upload-artifact@v4
        with:
          name: tunsafe-windows-msvc-x64
          path: dist\

  # ─────────────────────────────────────────────────────────────────
  # Windows MinGW — CLI static (на windows-latest для правильных заголовков)
  # ─────────────────────────────────────────────────────────────────
  build-windows-mingw:
    name: Windows MinGW static (${{ matrix.arch }})
    runs-on: windows-latest
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            flags: ""
          - arch: i686
            flags: "-m32"
    steps:
      - uses: actions/checkout@v4
      - name: Install MinGW
        shell: pwsh
        run: choco install mingw --no-progress -y
      - name: Build TunSafe
        shell: bash
        run: |
          export PATH="/c/ProgramData/chocolatey/lib/mingw/tools/install/mingw64/bin:$PATH"
          g++ \
            ${{ matrix.flags }} \
            -I . -O3 -DNDEBUG \
            -DWITH_NETWORK_WIN32=1 \
            -DCHACHA20_WITH_ASM=0 -DBLAKE2S_WITH_ASM=0 \
            -std=gnu++14 -static \
            -o tunsafe-windows-${{ matrix.arch }}.exe \
            tunsafe_amalgam.cpp \
            -lws2_32 -liphlpapi -lwinmm
          strip tunsafe-windows-${{ matrix.arch }}.exe
      - uses: actions/upload-artifact@v4
        if: success()
        with:
          name: tunsafe-windows-mingw-${{ matrix.arch }}
          path: tunsafe-windows-${{ matrix.arch }}.exe

  # ─────────────────────────────────────────────────────────────────
  # Android NDK — сборка libnative-lib.so
  # ─────────────────────────────────────────────────────────────────
  build-android:
    name: Android NDK (${{ matrix.abi }})
    runs-on: ubuntu-latest
    needs: patch-sources
    strategy:
      fail-fast: false
      matrix:
        include:
          - abi: arm64-v8a
            api: 21
          - abi: armeabi-v7a
            api: 21
          - abi: x86_64
            api: 21
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: patched-sources

      - name: Setup NDK r26d
        id: setup-ndk
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r26d
          add-to-path: true

      - name: Build libnative-lib.so (${{ matrix.abi }})
        env:
          NDK: ${{ steps.setup-ndk.outputs.ndk-path }}
        run: |
          mkdir -p build/android/${{ matrix.abi }}
          cmake \
            -S android \
            -B build/android/${{ matrix.abi }} \
            -DCMAKE_TOOLCHAIN_FILE="$NDK/build/cmake/android.toolchain.cmake" \
            -DANDROID_ABI=${{ matrix.abi }} \
            -DANDROID_PLATFORM=android-${{ matrix.api }} \
            -DCMAKE_BUILD_TYPE=Release \
            -DANDROID_STL=c++_static
          cmake --build build/android/${{ matrix.abi }} --parallel $(nproc)
          mkdir -p build/android/libs/${{ matrix.abi }}
          cp build/android/${{ matrix.abi }}/libnative-lib.so \
             build/android/libs/${{ matrix.abi }}/libnative-lib.so

      - uses: actions/upload-artifact@v4
        with:
          name: so-${{ matrix.abi }}
          path: build/android/libs/${{ matrix.abi }}/libnative-lib.so

  # ─────────────────────────────────────────────────────────────────
  # Android — инжект .so в APK и подпись
  # ─────────────────────────────────────────────────────────────────
  assemble-android-apk:
    name: Assemble Android APK
    needs: build-android
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download .so artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: so-*
          path: build/android/libs-raw
          merge-multiple: false

      - name: Fix libs directory layout
        run: |
          for abi in arm64-v8a armeabi-v7a x86_64; do
            src="build/android/libs-raw/so-${abi}/libnative-lib.so"
            dst="build/android/libs/${abi}/libnative-lib.so"
            if [ -f "$src" ]; then
              mkdir -p "$(dirname "$dst")"
              mv "$src" "$dst"
              echo "OK: $abi"
            fi
          done
          find build/android/libs -name "*.so" | sort

      - name: Install zipalign + apksigner
        run: sudo apt-get update -q && sudo apt-get install -y zipalign apksigner

      - name: Prepare keystore
        id: ks
        run: |
          if [ -n "${{ secrets.ANDROID_KEYSTORE_B64 }}" ]; then
            echo "${{ secrets.ANDROID_KEYSTORE_B64 }}" | base64 -d > signing.keystore
            echo "file=signing.keystore"                           >> $GITHUB_OUTPUT
            echo "alias=${{ secrets.ANDROID_KEY_ALIAS }}"         >> $GITHUB_OUTPUT
            echo "storepass=${{ secrets.ANDROID_KEYSTORE_PASS }}" >> $GITHUB_OUTPUT
            echo "keypass=${{ secrets.ANDROID_KEY_PASS }}"        >> $GITHUB_OUTPUT
          else
            keytool -genkeypair -keystore debug.keystore -alias tunsafe \
              -keyalg RSA -keysize 2048 -validity 3650 \
              -storepass debugpass -keypass debugpass \
              -dname "CN=TunSafe Debug,O=Debug,C=US" -noprompt
            echo "file=debug.keystore" >> $GITHUB_OUTPUT
            echo "alias=tunsafe"       >> $GITHUB_OUTPUT
            echo "storepass=debugpass" >> $GITHUB_OUTPUT
            echo "keypass=debugpass"   >> $GITHUB_OUTPUT
          fi

      - name: Check APK
        run: |
          [ -f android/TunSafe-Android.apk ] || {
            echo "::error::android/TunSafe-Android.apk not found"
            exit 1
          }

      - name: Inject .so and sign APK
        run: |
          chmod +x android/inject_so.sh
          VERSION="${GITHUB_REF_NAME:-dev}"
          android/inject_so.sh \
            --apk       android/TunSafe-Android.apk \
            --out       "TunSafe-Android-${VERSION}.apk" \
            --libs      build/android/libs \
            --keystore  ${{ steps.ks.outputs.file }} \
            --key-alias ${{ steps.ks.outputs.alias }} \
            --storepass "${{ steps.ks.outputs.storepass }}" \
            --keypass   "${{ steps.ks.outputs.keypass }}"
          echo "APK_FILE=TunSafe-Android-${VERSION}.apk" >> $GITHUB_ENV

      - uses: actions/upload-artifact@v4
        with:
          name: tunsafe-android-apk
          path: ${{ env.APK_FILE }}

  # ─────────────────────────────────────────────────────────────────
  # Release
  # ─────────────────────────────────────────────────────────────────
  release:
    name: Publish GitHub Release
    needs:
      - build-linux-x86_64
      - build-linux-i686
      - build-linux-armv7
      - build-linux-aarch64
      - build-windows-msvc
      - build-windows-mingw
      - assemble-android-apk
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Compress Linux binaries
        run: |
          for f in \
            artifacts/tunsafe-linux-x86_64/tunsafe-linux-x86_64 \
            artifacts/tunsafe-linux-i686/tunsafe-linux-i686 \
            artifacts/tunsafe-linux-armv7/tunsafe-linux-armv7 \
            artifacts/tunsafe-linux-aarch64/tunsafe-linux-aarch64; do
            [ -f "$f" ] && gzip -9 -k "$f" || true
          done

      - name: SHA256 checksums
        run: find artifacts/ -type f | sort | xargs sha256sum | tee SHA256SUMS.txt

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: TunSafe ${{ github.ref_name }}
          draft: false
          prerelease: ${{ contains(github.ref_name, '-rc') || contains(github.ref_name, '-beta') || contains(github.ref_name, '-alpha') }}
          generate_release_notes: true
          body: |
            ## TunSafe ${{ github.ref_name }}

            > Android APK собран из исходников этого коммита.

            | Платформа | Архитектура | Примечание |
            |-----------|-------------|-----------|
            | Linux | x86_64 | static + ASM |
            | Linux | i686 | static |
            | Linux | ARMv7 | static, NEON |
            | Linux | AArch64 | static |
            | Windows | x86_64 GUI | MSVC v143 |
            | Android | arm64-v8a + armeabi-v7a + x86_64 | NDK r26d |

            Проверка целостности: `SHA256SUMS.txt`
          files: |
            artifacts/**/*
            SHA256SUMS.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
