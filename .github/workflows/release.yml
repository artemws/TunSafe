name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

# ─────────────────────────────────────────────────────────────────────────────
# CHANGES vs previous run:
#
# FIX - Android linker "undefined symbol: CreateTunsafePlugin":
#   Root cause: tunsafe_wg_plugin.cpp is designed for amalgam-only builds
#   (it contains #pragma once and is meant to be #include'd, not compiled as
#   a standalone TU). When compiled separately by NDK/CMake, the symbol
#   CreateTunsafePlugin was not consistently visible to the linker.
#
#   CORRECT FIX:
#   - Remove tunsafe_wg_plugin.cpp from CMakeLists CORE_SOURCES entirely.
#   - Remove the PluginDelegate inheritance from AndroidBackend.
#   - Pass nullptr to processor_.dev().SetPlugin() — safe because
#     WireguardProcessor null-checks before using the plugin pointer.
#   - No more patching of tunsafe_wg_plugin.h needed.
#
# patch-sources now only patches ip_to_peer_map.cpp (offsetof VLA fix).
# ─────────────────────────────────────────────────────────────────────────────

jobs:

  # ─────────────────────────────────────────────────────────────────
  # Патч ip_to_peer_map.cpp — offsetof с VLA не работает в GCC 10+
  # ─────────────────────────────────────────────────────────────────
  patch-sources:
    name: Patch sources
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Patch ip_to_peer_map.cpp (offsetof VLA)
        run: |
          sed -i \
            's/malloc(offsetof(RoutingTrie32::Node, child\[(uint32)(1U << bits)\]))/malloc(offsetof(RoutingTrie32::Node, child) + ((size_t)(1U << bits)) * sizeof(RoutingTrie32::Node*))/' \
            ip_to_peer_map.cpp
          grep -n "malloc(offsetof" ip_to_peer_map.cpp

      - uses: actions/upload-artifact@v4
        with:
          name: patched-sources
          path: ip_to_peer_map.cpp

  # ─────────────────────────────────────────────────────────────────
  # Linux x86_64 — static + ASM
  # ─────────────────────────────────────────────────────────────────
  build-linux-x86_64:
    name: Linux x86_64 (static + ASM)
    runs-on: ubuntu-latest
    needs: patch-sources
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: patched-sources
      - name: Install dependencies
        run: sudo apt-get update -q && sudo apt-get install -y gcc g++ binutils
      - name: Build ASM objects
        run: |
          gcc -c -march=skylake-avx512 \
            crypto/poly1305/poly1305-x64-linux.s \
            crypto/chacha20/chacha20-x64-linux.s
      - name: Build TunSafe
        run: |
          g++ -I . -O3 -DNDEBUG \
            -DWITH_NETWORK_BSD=1 \
            -mssse3 -std=gnu++14 \
            -static -pthread \
            -o tunsafe-linux-x86_64 \
            tunsafe_amalgam.cpp \
            crypto/aesgcm/aesni_gcm-x64-linux.s \
            crypto/aesgcm/aesni-x64-linux.s \
            crypto/aesgcm/ghash-x64-linux.s \
            chacha20-x64-linux.o \
            poly1305-x64-linux.o \
            -lrt
          strip tunsafe-linux-x86_64
          file tunsafe-linux-x86_64
      - uses: actions/upload-artifact@v4
        with:
          name: tunsafe-linux-x86_64
          path: tunsafe-linux-x86_64

  # ─────────────────────────────────────────────────────────────────
  # Linux i686 — static
  # ─────────────────────────────────────────────────────────────────
  build-linux-i686:
    name: Linux i686 (static)
    runs-on: ubuntu-latest
    needs: patch-sources
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: patched-sources
      - name: Install dependencies
        run: sudo apt-get update -q && sudo apt-get install -y gcc-multilib g++-multilib
      - name: Build TunSafe
        run: |
          g++ -m32 -I . -O3 -DNDEBUG \
            -DWITH_NETWORK_BSD=1 \
            -DCHACHA20_WITH_ASM=0 -DBLAKE2S_WITH_ASM=0 \
            -mssse3 -std=gnu++14 \
            -static -pthread \
            -o tunsafe-linux-i686 \
            tunsafe_amalgam.cpp \
            -lrt
          strip tunsafe-linux-i686
          file tunsafe-linux-i686
      - uses: actions/upload-artifact@v4
        with:
          name: tunsafe-linux-i686
          path: tunsafe-linux-i686

  # ─────────────────────────────────────────────────────────────────
  # Linux ARMv7 — apt cross-compiler (gnueabihf, hard-float)
  # dockcross/linux-armv7 dropped: uses gnueabi (soft-float) and its static
  # linker exits with error 127 on getaddrinfo. The Ubuntu apt toolchain
  # (gnueabihf) is simpler, more reliable, and targets hard-float ABI
  # which is correct for Raspberry Pi and most modern ARMv7 boards.
  # ─────────────────────────────────────────────────────────────────
  build-linux-armv7:
    name: Linux ARMv7 (static)
    runs-on: ubuntu-latest
    needs: patch-sources
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: patched-sources
      - name: Install cross-compiler
        run: |
          sudo apt-get update -q
          sudo apt-get install -y gcc-arm-linux-gnueabihf g++-arm-linux-gnueabihf
      - name: Build TunSafe
        run: |
          arm-linux-gnueabihf-g++ \
            -I . -O2 -DNDEBUG \
            -DWITH_NETWORK_BSD=1 \
            -DCHACHA20_WITH_ASM=0 -DBLAKE2S_WITH_ASM=0 \
            -mfpu=neon -march=armv7-a \
            -std=gnu++14 -static -pthread \
            -o tunsafe-linux-armv7 \
            tunsafe_amalgam.cpp -lrt
          arm-linux-gnueabihf-strip tunsafe-linux-armv7
          file tunsafe-linux-armv7
      - uses: actions/upload-artifact@v4
        with:
          name: tunsafe-linux-armv7
          path: tunsafe-linux-armv7

  # ─────────────────────────────────────────────────────────────────
  # Linux AArch64 — apt cross-compiler
  # dockcross/linux-arm64 dropped: ld.bfd exits 127 on getaddrinfo
  # with -static (same issue as ARMv7 dockcross toolchain).
  # ─────────────────────────────────────────────────────────────────
  build-linux-aarch64:
    name: Linux AArch64/ARMv8 (static)
    runs-on: ubuntu-latest
    needs: patch-sources
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: patched-sources
      - name: Install cross-compiler
        run: |
          sudo apt-get update -q
          sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
      - name: Build TunSafe
        run: |
          aarch64-linux-gnu-g++ \
            -I . -O2 -DNDEBUG \
            -DWITH_NETWORK_BSD=1 \
            -DCHACHA20_WITH_ASM=0 -DBLAKE2S_WITH_ASM=0 \
            -std=gnu++14 -static -pthread \
            -o tunsafe-linux-aarch64 \
            tunsafe_amalgam.cpp -lrt
          aarch64-linux-gnu-strip tunsafe-linux-aarch64
          file tunsafe-linux-aarch64
      - uses: actions/upload-artifact@v4
        with:
          name: tunsafe-linux-aarch64
          path: tunsafe-linux-aarch64

  # ─────────────────────────────────────────────────────────────────
  # Windows MSVC — GUI
  # ─────────────────────────────────────────────────────────────────
  build-windows-msvc:
    name: Windows MSVC x64 (GUI)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: microsoft/setup-msbuild@v2
      - name: Build
        run: |
          msbuild TunSafe.sln `
            /p:Configuration=Release `
            /p:Platform=x64 `
            /p:WindowsTargetPlatformVersion=10.0 `
            /p:PlatformToolset=v143 `
            /m /nologo
      - name: Collect artifacts
        shell: pwsh
        run: |
          New-Item -Force -ItemType Directory dist | Out-Null
          Get-ChildItem -Recurse -Filter "*.exe" |
            Where-Object { $_.FullName -match 'x64.Release' } |
            ForEach-Object { Copy-Item $_.FullName dist\ -Force }
          dir dist
      - uses: actions/upload-artifact@v4
        with:
          name: tunsafe-windows-msvc-x64
          path: dist\

  # ─────────────────────────────────────────────────────────────────
  # Windows MinGW — CLI static (на windows-latest)
  # ─────────────────────────────────────────────────────────────────
  build-windows-mingw:
    name: Windows MinGW static (${{ matrix.arch }})
    runs-on: windows-latest
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            flags: ""
          - arch: i686
            flags: "-m32"
    steps:
      - uses: actions/checkout@v4
      - name: Install MinGW
        shell: pwsh
        run: choco install mingw --no-progress -y
      - name: Build TunSafe
        shell: bash
        run: |
          export PATH="/c/ProgramData/chocolatey/lib/mingw/tools/install/mingw64/bin:$PATH"
          g++ \
            ${{ matrix.flags }} \
            -I . -O3 -DNDEBUG \
            -DWITH_NETWORK_WIN32=1 \
            -DCHACHA20_WITH_ASM=0 -DBLAKE2S_WITH_ASM=0 \
            -std=gnu++14 -static \
            -o tunsafe-windows-${{ matrix.arch }}.exe \
            tunsafe_amalgam.cpp \
            -lws2_32 -liphlpapi -lwinmm
          strip tunsafe-windows-${{ matrix.arch }}.exe
      - uses: actions/upload-artifact@v4
        if: success()
        with:
          name: tunsafe-windows-mingw-${{ matrix.arch }}
          path: tunsafe-windows-${{ matrix.arch }}.exe

  # ─────────────────────────────────────────────────────────────────
  # Android NDK — сборка libnative-lib.so
  # ─────────────────────────────────────────────────────────────────
  build-android:
    name: Android NDK (${{ matrix.abi }})
    runs-on: ubuntu-latest
    needs: patch-sources
    strategy:
      fail-fast: false
      matrix:
        include:
          - abi: arm64-v8a
            api: 21
          - abi: armeabi-v7a
            api: 21
          - abi: x86_64
            api: 21
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: patched-sources

      - name: Setup NDK r26d
        id: setup-ndk
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r26d
          add-to-path: true

      - name: Build libnative-lib.so (${{ matrix.abi }})
        env:
          NDK: ${{ steps.setup-ndk.outputs.ndk-path }}
        run: |
          mkdir -p build/android/${{ matrix.abi }}
          cmake \
            -S android \
            -B build/android/${{ matrix.abi }} \
            -DCMAKE_TOOLCHAIN_FILE="$NDK/build/cmake/android.toolchain.cmake" \
            -DANDROID_ABI=${{ matrix.abi }} \
            -DANDROID_PLATFORM=android-${{ matrix.api }} \
            -DCMAKE_BUILD_TYPE=Release \
            -DANDROID_STL=c++_static
          cmake --build build/android/${{ matrix.abi }} --parallel $(nproc)
          mkdir -p build/android/libs/${{ matrix.abi }}
          cp build/android/${{ matrix.abi }}/libnative-lib.so \
             build/android/libs/${{ matrix.abi }}/libnative-lib.so

      - uses: actions/upload-artifact@v4
        with:
          name: so-${{ matrix.abi }}
          path: build/android/libs/${{ matrix.abi }}/libnative-lib.so

  # ─────────────────────────────────────────────────────────────────
  # Android — инжект .so в APK и подпись
  # ─────────────────────────────────────────────────────────────────
  assemble-android-apk:
    name: Assemble Android APK
    needs: build-android
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download .so artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: so-*
          path: build/android/libs-raw
          merge-multiple: false

      - name: Fix libs directory layout
        run: |
          # upload-artifact v4 preserves relative paths inside the artifact,
          # so the download creates a nested structure like:
          #   libs-raw/so-arm64-v8a/build/android/libs/arm64-v8a/libnative-lib.so
          # Use find to locate files regardless of nesting depth.
          for abi in arm64-v8a armeabi-v7a x86_64; do
            found=$(find build/android/libs-raw -path "*/${abi}/libnative-lib.so" | head -1)
            if [ -n "$found" ]; then
              mkdir -p "build/android/libs/${abi}"
              mv "$found" "build/android/libs/${abi}/libnative-lib.so"
              echo "OK: $abi -> build/android/libs/${abi}/libnative-lib.so"
            else
              echo "WARN: no .so found for $abi"
            fi
          done
          echo "Final libs:"
          find build/android/libs -name "*.so" | sort

      - name: Install zipalign + apksigner
        run: sudo apt-get update -q && sudo apt-get install -y zipalign apksigner

      - name: Prepare keystore
        id: ks
        run: |
          if [ -n "${{ secrets.ANDROID_KEYSTORE_B64 }}" ]; then
            echo "${{ secrets.ANDROID_KEYSTORE_B64 }}" | base64 -d > signing.keystore
            echo "file=signing.keystore"                           >> $GITHUB_OUTPUT
            echo "alias=${{ secrets.ANDROID_KEY_ALIAS }}"         >> $GITHUB_OUTPUT
            echo "storepass=${{ secrets.ANDROID_KEYSTORE_PASS }}" >> $GITHUB_OUTPUT
            echo "keypass=${{ secrets.ANDROID_KEY_PASS }}"        >> $GITHUB_OUTPUT
          else
            keytool -genkeypair -keystore debug.keystore -alias tunsafe \
              -keyalg RSA -keysize 2048 -validity 3650 \
              -storepass debugpass -keypass debugpass \
              -dname "CN=TunSafe Debug,O=Debug,C=US" -noprompt
            echo "file=debug.keystore" >> $GITHUB_OUTPUT
            echo "alias=tunsafe"       >> $GITHUB_OUTPUT
            echo "storepass=debugpass" >> $GITHUB_OUTPUT
            echo "keypass=debugpass"   >> $GITHUB_OUTPUT
          fi

      - name: Check APK
        run: |
          [ -f android/TunSafe-Android.apk ] || {
            echo "::error::android/TunSafe-Android.apk not found"
            exit 1
          }

      - name: Inject .so and sign APK
        run: |
          chmod +x android/inject_so.sh
          VERSION="${GITHUB_REF_NAME:-dev}"
          android/inject_so.sh \
            --apk       android/TunSafe-Android.apk \
            --out       "TunSafe-Android-${VERSION}.apk" \
            --libs      build/android/libs \
            --keystore  ${{ steps.ks.outputs.file }} \
            --key-alias ${{ steps.ks.outputs.alias }} \
            --storepass "${{ steps.ks.outputs.storepass }}" \
            --keypass   "${{ steps.ks.outputs.keypass }}"
          echo "APK_FILE=TunSafe-Android-${VERSION}.apk" >> $GITHUB_ENV

      - uses: actions/upload-artifact@v4
        with:
          name: tunsafe-android-apk
          path: ${{ env.APK_FILE }}

  # ─────────────────────────────────────────────────────────────────
  # Release
  # ─────────────────────────────────────────────────────────────────
  release:
    name: Publish GitHub Release
    needs:
      - build-linux-x86_64
      - build-linux-i686
      - build-linux-armv7
      - build-linux-aarch64
      - build-windows-msvc
      - build-windows-mingw
      - assemble-android-apk
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Compress Linux binaries
        run: |
          for f in \
            artifacts/tunsafe-linux-x86_64/tunsafe-linux-x86_64 \
            artifacts/tunsafe-linux-i686/tunsafe-linux-i686 \
            artifacts/tunsafe-linux-armv7/tunsafe-linux-armv7 \
            artifacts/tunsafe-linux-aarch64/tunsafe-linux-aarch64; do
            [ -f "$f" ] && gzip -9 -k "$f" || true
          done

      - name: SHA256 checksums
        run: find artifacts/ -type f | sort | xargs sha256sum | tee SHA256SUMS.txt

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: TunSafe ${{ github.ref_name }}
          draft: false
          prerelease: ${{ contains(github.ref_name, '-rc') || contains(github.ref_name, '-beta') || contains(github.ref_name, '-alpha') }}
          generate_release_notes: true
          body: |
            ## TunSafe ${{ github.ref_name }}

            > Android APK собран из исходников этого коммита.

            | Платформа | Архитектура | Примечание |
            |-----------|-------------|-----------|
            | Linux | x86_64 | static + ASM |
            | Linux | i686 | static |
            | Linux | ARMv7 | static |
            | Linux | AArch64 | static |
            | Windows | x86_64 GUI | MSVC v143 |
            | Android | arm64-v8a + armeabi-v7a + x86_64 | NDK r26d |

            Проверка целостности: `SHA256SUMS.txt`
          files: |
            artifacts/**/*
            SHA256SUMS.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
