name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

# ─────────────────────────────────────────────────────────────────────────────
# OVERVIEW
#
# Linux  : static musl binaries via muslcc / dockcross
#   • x86_64  (with x64 ASM for ChaCha20/Poly1305/AES-GCM)
#   • i686
#   • armv7   (armeabi-v7a, NEON)
#   • aarch64 (ARMv8)
#
# Windows: MSVC (full GUI .sln) + MinGW static CLI (x64, x86)
#
# Android: NDK builds libnative-lib.so from C++ sources, injects into
#          the prebuilt APK (android/TunSafe-Android.apk), re-signs.
#          So every change to .cpp files IS reflected in the APK.
# ─────────────────────────────────────────────────────────────────────────────

jobs:

  # ─────────────────────────────────────────────────────────────────
  # Linux x86_64 — musl static, with x64 ASM
  # ─────────────────────────────────────────────────────────────────
  build-linux-x86_64:
    name: Linux x86_64 (musl+ASM)
    runs-on: ubuntu-latest
    container:
      image: muslcc/x86_64:x86_64-linux-musl
    steps:
      - uses: actions/checkout@v4
      - name: Install clang
        run: apk add --no-cache clang
      - name: Build ASM objects
        run: |
          clang++ -c -march=skylake-avx512 \
            crypto/poly1305/poly1305-x64-linux.s \
            crypto/chacha20/chacha20-x64-linux.s
      - name: Build TunSafe
        run: |
          clang++ -I . -O3 -DNDEBUG \
            -DWITH_NETWORK_BSD=1 -mssse3 \
            -static -pthread \
            -o tunsafe-linux-x86_64 \
            tunsafe_amalgam.cpp \
            crypto/aesgcm/aesni_gcm-x64-linux.s \
            crypto/aesgcm/aesni-x64-linux.s \
            crypto/aesgcm/ghash-x64-linux.s \
            chacha20-x64-linux.o poly1305-x64-linux.o \
            -lrt
          strip tunsafe-linux-x86_64
      - uses: actions/upload-artifact@v4
        with:
          name: tunsafe-linux-x86_64
          path: tunsafe-linux-x86_64

  # ─────────────────────────────────────────────────────────────────
  # Linux i686 — musl static
  # ─────────────────────────────────────────────────────────────────
  build-linux-i686:
    name: Linux i686 (musl)
    runs-on: ubuntu-latest
    container:
      image: muslcc/x86_64:i686-linux-musl
    steps:
      - uses: actions/checkout@v4
      - name: Install clang
        run: apk add --no-cache clang
      - name: Build TunSafe
        run: |
          clang++ -I . -O3 -DNDEBUG \
            -DWITH_NETWORK_BSD=1 \
            -DCHACHA20_WITH_ASM=0 -DBLAKE2S_WITH_ASM=0 \
            -mssse3 -m32 -static -pthread \
            -o tunsafe-linux-i686 tunsafe_amalgam.cpp -lrt
          strip tunsafe-linux-i686
      - uses: actions/upload-artifact@v4
        with:
          name: tunsafe-linux-i686
          path: tunsafe-linux-i686

  # ─────────────────────────────────────────────────────────────────
  # Linux ARMv7 — dockcross
  # ─────────────────────────────────────────────────────────────────
  build-linux-armv7:
    name: Linux ARMv7 (dockcross)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup dockcross
        run: |
          docker run --rm dockcross/linux-armv7 > ./dockcross-armv7
          chmod +x ./dockcross-armv7
      - name: Build
        run: |
          ./dockcross-armv7 bash -c "
            set -e
            arm-linux-gnueabihf-g++ -I . -O3 -DNDEBUG \
              -DWITH_NETWORK_BSD=1 \
              -DCHACHA20_WITH_ASM=0 -DBLAKE2S_WITH_ASM=0 \
              -mfpu=neon -march=armv7-a+fp \
              -static -pthread \
              -o tunsafe-linux-armv7 tunsafe_amalgam.cpp -lrt
            arm-linux-gnueabihf-strip tunsafe-linux-armv7
          "
      - uses: actions/upload-artifact@v4
        with:
          name: tunsafe-linux-armv7
          path: tunsafe-linux-armv7

  # ─────────────────────────────────────────────────────────────────
  # Linux AArch64 — dockcross
  # ─────────────────────────────────────────────────────────────────
  build-linux-aarch64:
    name: Linux AArch64/ARMv8 (dockcross)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup dockcross
        run: |
          docker run --rm dockcross/linux-arm64 > ./dockcross-aarch64
          chmod +x ./dockcross-aarch64
      - name: Build
        run: |
          ./dockcross-aarch64 bash -c "
            set -e
            aarch64-unknown-linux-gnu-g++ -I . -O3 -DNDEBUG \
              -DWITH_NETWORK_BSD=1 \
              -DCHACHA20_WITH_ASM=0 -DBLAKE2S_WITH_ASM=0 \
              -static -pthread \
              -o tunsafe-linux-aarch64 tunsafe_amalgam.cpp -lrt
            aarch64-unknown-linux-gnu-strip tunsafe-linux-aarch64
          "
      - uses: actions/upload-artifact@v4
        with:
          name: tunsafe-linux-aarch64
          path: tunsafe-linux-aarch64

  # ─────────────────────────────────────────────────────────────────
  # Windows — MSVC GUI
  # ─────────────────────────────────────────────────────────────────
  build-windows-msvc:
    name: Windows MSVC x64 (GUI)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: microsoft/setup-msbuild@v2
      - name: Build
        run: msbuild TunSafe.sln /p:Configuration=Release /p:Platform=x64 /m /nologo
      - name: Collect
        shell: pwsh
        run: |
          New-Item -Force -ItemType Directory dist | Out-Null
          Get-ChildItem -Recurse -Filter TunSafe.exe |
            Where-Object { $_.FullName -match 'Release' } |
            ForEach-Object { Copy-Item $_.FullName dist\ -Force }
      - uses: actions/upload-artifact@v4
        with:
          name: tunsafe-windows-msvc-x64
          path: dist\

  # ─────────────────────────────────────────────────────────────────
  # Windows — MinGW static CLI
  # ─────────────────────────────────────────────────────────────────
  build-windows-mingw:
    name: Windows MinGW static (${{ matrix.arch }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            triple: x86_64-w64-mingw32
          - arch: i686
            triple: i686-w64-mingw32
    steps:
      - uses: actions/checkout@v4
      - name: Install MinGW
        run: sudo apt-get update -q && sudo apt-get install -y mingw-w64
      - name: Build
        run: |
          ${{ matrix.triple }}-g++ -I . -O3 -DNDEBUG \
            -DWITH_NETWORK_WIN32=1 \
            -DCHACHA20_WITH_ASM=0 -DBLAKE2S_WITH_ASM=0 \
            -static \
            -o tunsafe-windows-${{ matrix.arch }}.exe \
            tunsafe_amalgam.cpp \
            -lws2_32 -liphlpapi -lwinmm \
          || { echo "::warning::MinGW build failed"; exit 0; }
          ${{ matrix.triple }}-strip tunsafe-windows-${{ matrix.arch }}.exe 2>/dev/null || true
      - uses: actions/upload-artifact@v4
        with:
          name: tunsafe-windows-mingw-${{ matrix.arch }}
          path: tunsafe-windows-${{ matrix.arch }}.exe

  # ─────────────────────────────────────────────────────────────────
  # Android — build libnative-lib.so via NDK, inject into APK
  #
  # Changes to .cpp files ARE picked up here:
  #   tunsafe_amalgam.cpp + android/tunsafe_jni.cpp + android/tunsafe_android.cpp
  #   → libnative-lib.so  → injected into android/TunSafe-Android.apk
  #
  # Signing key:
  #   • For debug builds (workflow_dispatch) a throwaway keystore is generated.
  #   • For release tags: store your keystore in GitHub Secrets and set
  #     ANDROID_KEYSTORE_B64, ANDROID_KEYSTORE_PASS, ANDROID_KEY_PASS,
  #     ANDROID_KEY_ALIAS in your repo secrets.
  # ─────────────────────────────────────────────────────────────────
  build-android:
    name: Android NDK (${{ matrix.abi }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - abi: arm64-v8a
            api: 21
          - abi: armeabi-v7a
            api: 19
          - abi: x86_64
            api: 21

    steps:
      - uses: actions/checkout@v4

      - name: Setup Android NDK r26d
        id: setup-ndk
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r26d
          add-to-path: true

      - name: Build libnative-lib.so (${{ matrix.abi }})
        env:
          NDK: ${{ steps.setup-ndk.outputs.ndk-path }}
        run: |
          mkdir -p build/android/${{ matrix.abi }}

          cmake \
            -S android \
            -B build/android/${{ matrix.abi }} \
            -DCMAKE_TOOLCHAIN_FILE="$NDK/build/cmake/android.toolchain.cmake" \
            -DANDROID_ABI=${{ matrix.abi }} \
            -DANDROID_PLATFORM=android-${{ matrix.api }} \
            -DCMAKE_BUILD_TYPE=Release \
            -DANDROID_STL=c++_static

          cmake --build build/android/${{ matrix.abi }} --parallel $(nproc)

          # Collect to unified libs/ layout expected by inject_so.sh
          mkdir -p build/android/libs/${{ matrix.abi }}
          cp build/android/${{ matrix.abi }}/libnative-lib.so \
             build/android/libs/${{ matrix.abi }}/libnative-lib.so

      - name: Upload .so artifact
        uses: actions/upload-artifact@v4
        with:
          name: so-${{ matrix.abi }}
          path: build/android/libs/${{ matrix.abi }}/libnative-lib.so

  # ─────────────────────────────────────────────────────────────────
  # Android — assemble APK (inject all .so, re-sign)
  # ─────────────────────────────────────────────────────────────────
  assemble-android-apk:
    name: Assemble Android APK
    needs: build-android
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # Download all .so artifacts into libs/ layout
      - name: Download arm64-v8a .so
        uses: actions/download-artifact@v4
        with:
          name: so-arm64-v8a
          path: build/android/libs/arm64-v8a

      - name: Download armeabi-v7a .so
        uses: actions/download-artifact@v4
        with:
          name: so-armeabi-v7a
          path: build/android/libs/armeabi-v7a

      - name: Download x86_64 .so
        uses: actions/download-artifact@v4
        with:
          name: so-x86_64
          path: build/android/libs/x86_64

      # Setup signing key
      - name: Prepare signing keystore
        id: keystore
        run: |
          if [[ -n "${{ secrets.ANDROID_KEYSTORE_B64 }}" ]]; then
            echo "${{ secrets.ANDROID_KEYSTORE_B64 }}" | base64 -d > release.keystore
            echo "keystore=release.keystore"         >> $GITHUB_OUTPUT
            echo "alias=${{ secrets.ANDROID_KEY_ALIAS || 'tunsafe' }}" >> $GITHUB_OUTPUT
            echo "mode=release"                      >> $GITHUB_OUTPUT
          else
            # Generate a debug keystore (workflow_dispatch / no secrets)
            keytool -genkeypair \
              -keystore debug.keystore -alias tunsafe \
              -keyalg RSA -keysize 2048 -validity 3650 \
              -storepass debugpass -keypass debugpass \
              -dname "CN=TunSafe Debug,O=Debug,C=US" -noprompt
            echo "keystore=debug.keystore" >> $GITHUB_OUTPUT
            echo "alias=tunsafe"           >> $GITHUB_OUTPUT
            echo "mode=debug"              >> $GITHUB_OUTPUT
          fi

      - name: Install apksigner + zipalign
        run: |
          sudo apt-get update -q
          sudo apt-get install -y zipalign apksigner

      - name: Check APK exists
        run: |
          [[ -f android/TunSafe-Android.apk ]] || {
            echo "::error::android/TunSafe-Android.apk not found."
            echo "Commit the APK to android/TunSafe-Android.apk in the repo."
            exit 1
          }

      - name: Inject .so files into APK
        env:
          STOREPASS: ${{ secrets.ANDROID_KEYSTORE_PASS || 'debugpass' }}
          KEYPASS:   ${{ secrets.ANDROID_KEY_PASS      || 'debugpass' }}
        run: |
          chmod +x android/inject_so.sh

          VERSION="${GITHUB_REF_NAME:-dev}"
          OUT="TunSafe-Android-${VERSION}.apk"

          android/inject_so.sh \
            --apk       android/TunSafe-Android.apk \
            --out       "$OUT" \
            --libs      build/android/libs \
            --keystore  ${{ steps.keystore.outputs.keystore }} \
            --key-alias ${{ steps.keystore.outputs.alias }} \
            --storepass "$STOREPASS" \
            --keypass   "$KEYPASS"

          echo "APK_FILE=$OUT" >> $GITHUB_ENV
          echo "SIGN_MODE=${{ steps.keystore.outputs.mode }}" >> $GITHUB_ENV

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: tunsafe-android-apk
          path: ${{ env.APK_FILE }}

  # ─────────────────────────────────────────────────────────────────
  # Release — publish to GitHub
  # ─────────────────────────────────────────────────────────────────
  release:
    name: Publish GitHub Release
    needs:
      - build-linux-x86_64
      - build-linux-i686
      - build-linux-armv7
      - build-linux-aarch64
      - build-windows-msvc
      - build-windows-mingw
      - assemble-android-apk
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: List files
        run: find artifacts/ -type f | sort

      - name: Compress Linux binaries
        run: |
          for f in \
            artifacts/tunsafe-linux-x86_64/tunsafe-linux-x86_64 \
            artifacts/tunsafe-linux-i686/tunsafe-linux-i686 \
            artifacts/tunsafe-linux-armv7/tunsafe-linux-armv7 \
            artifacts/tunsafe-linux-aarch64/tunsafe-linux-aarch64; do
            [ -f "$f" ] && gzip -9 -k "$f" || true
          done

      - name: SHA256 checksums
        run: find artifacts/ -type f | sort | xargs sha256sum | tee SHA256SUMS.txt

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: TunSafe ${{ github.ref_name }}
          draft: false
          prerelease: ${{ contains(github.ref_name, '-rc') || contains(github.ref_name, '-beta') || contains(github.ref_name, '-alpha') }}
          generate_release_notes: true
          body: |
            ## TunSafe ${{ github.ref_name }}

            > The Android APK is built from **this commit's C++ sources** — changes
            > to `tunsafe_amalgam.cpp` and related files are reflected in the APK.

            ### Downloads

            | Platform | Architecture | Notes |
            |----------|-------------|-------|
            | Linux | x86_64 | musl static + ASM |
            | Linux | i686 | musl static |
            | Linux | ARMv7 | musl static, NEON |
            | Linux | AArch64/ARMv8 | musl static |
            | Windows | x86_64 GUI | MSVC Release |
            | Windows | x86_64 CLI | MinGW static |
            | Windows | i686 CLI | MinGW static |
            | Android | arm64-v8a + armeabi-v7a + x86_64 | NDK-built .so injected into APK |

            Verify integrity with `SHA256SUMS.txt`.
          files: |
            artifacts/**/*
            SHA256SUMS.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
